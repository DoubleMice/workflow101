# 作业 4：Compliance Test Workflow

> 构建一个自动化合规检测工具，检查终端设备 / 移动操作系统代码是否符合工信部及网络安全法律法规要求。

**核心模式**：Explore → Specialized Agent → Fan-out/Fan-in → Sequential → Event-Driven

**术语**

- 网络安全法（2017 年施行，网络运营者安全保护义务的基本法）
- 个人信息保护法 / PIPL（2021 年施行，个人信息处理规则）
- 数据安全法（2021 年施行，数据处理活动的安全与监管框架）
- 工信部 164 号文（《关于进一步规范移动智能终端应用软件预置行为的通告》，预置 App 可卸载要求）
- GB/T 41391-2022（《移动互联网应用程序（App）收集个人信息基本要求》，最小必要原则）
- 等保 2.0 移动互联安全扩展（GB/T 22239-2019 附录 F，移动终端安全计算环境要求）
- 密码法（2020 年施行，商用密码应用与管理规范）
- 工信部 App 侵害用户权益专项整治（自 2019 年起持续开展，覆盖违规收集信息、强制捆绑、弹窗骚扰等）

---

## 背景

你的团队负责一款国产移动操作系统的系统级组件开发（C/C++ 实现）。产品即将送检入网，工信部和安全合规团队同时提出要求：系统代码必须通过合规审查，覆盖预置应用管理、个人信息收集、数据存储传输、用户权益保护等多个维度。

手动逐条对照法规太痛苦了——仅 GB/T 41391 就定义了 39 类个人信息的最小必要收集规则，工信部历次专项整治通报涉及的违规类型超过 20 种，等保 2.0 移动互联扩展要求又有数十条技术细则。你决定用 Claude Code 的 workflow 编排，构建一个自动化合规检测工具，按法规维度分类扫描代码，输出合规报告和整改建议。

---

## 需求描述

### 功能需求

**输入**: 一个本地终端设备 / 移动 OS 项目的路径，可选指定法规维度

**输出**:
- 合规检测报告（Markdown 格式）
- 按法规维度分类的违规列表（法规条款、违规位置、风险等级）
- 每条违规的整改建议和代码示例
- 整体合规评级和入网送检风险评估

### 检测范围

合规检测至少需要覆盖以下法规领域（供参考，不是 agent 拆分方案）：

| 法规领域 | 对应法规 | 关注点 |
|---------|---------|--------|
| 个人信息收集 | 个人信息保护法、GB/T 41391-2022 | 最小必要原则、权限与功能匹配、用户同意前置、静默采集设备标识/位置/通讯录 |
| 预置应用与分发 | 工信部 164 号文 | 预置 App 可卸载、第三方应用管理、OTA 推送明示、分发渠道签名校验 |
| 数据存储与传输 | 数据安全法、密码法、等保 2.0 移动扩展 | 敏感数据明文落盘、密钥硬编码、TLS 1.2+、国密算法（SM2/SM3/SM4）、证书校验 |
| 用户权益保护 | 工信部专项整治、网络安全法 | 开屏弹窗强制跳转、强制捆绑下载、频繁自启动/关联启动、欺骗误导点击、通知权限 |
| 终端安全能力 | 等保 2.0 移动互联扩展（附录 F） | 安全启动链、应用沙箱隔离、恶意代码防护、安全审计日志、远程锁定与擦除 |

### 你需要自己决定的事

法规维度是客观存在的，但"法规维度"不等于"agent 架构"。在动手之前，先想清楚这几个设计问题：

**Q1: 法规维度怎么映射到 agent？**

5 个法规领域不一定要用 5 个 agent。几种思路：

- **一对一映射**：每个法规领域一个 agent，最直观。但有些法规之间有交叉——比如"数据存储与传输"和"个人信息收集"都关心敏感数据的处理方式，会重复扫描。
- **按代码区域拆**：每个 agent 负责一组相关模块（如网络层、存储层、权限管理层），在自己的区域内检查所有相关法规。减少重复扫描，但 agent 需要理解多部法规。
- **两阶段混合**：先并行做各法规维度的初筛，再串行做跨维度的关联分析（比如"收集了个人信息但传输时未加密"横跨两个维度）。

**Q2: 评级体系怎么设计？**

合规评级比安全审计更复杂，因为不同违规的法律后果差异巨大：
- 静默收集个人信息可能导致 App 下架甚至行政处罚
- 预置应用不可卸载可能被工信部通报
- 缺少国密算法支持可能影响入网送检但不会被处罚

你的评级应该基于什么？违规数量？法律后果严重程度？入网送检通过概率？还是综合考虑？

**Q3: `--fix` 自动整改的边界在哪？**

有些违规可以自动修复（如补充审计日志字段、替换明文存储为加密存储），有些不能（如重新设计权限申请流程、调整预置应用策略）。你需要决定：
- 哪些类型的违规尝试自动修复，哪些只给建议？
- 自动生成的补丁怎么验证——编译通过就行，还是需要跑测试？
- 修复失败怎么处理——回退并标记，还是保留部分修复？

### 技术要求

1. 用 CLI 封装（typer），支持 `comply check <project-path>` 命令
2. 支持 `--standard` 参数选择法规维度（`pipl` 个保法 / `miit` 工信部规定 / `mlps2` 等保 2.0 / `all` 全部）
3. agent 的数量和分工由你自己设计——不一定和法规维度一一对应
4. 检测前先用 Explore agent 理解项目结构、权限声明文件、系统服务清单、预置应用列表
5. 每条违规标注对应的法规条款（如"PIPL 第 6 条 — 最小必要原则"、"工信部 164 号文 — 预置应用可卸载"）
6. 支持 `--fix` 参数，自动生成整改补丁（整改边界由你设计）
7. 支持 `--output` 参数选择输出格式（markdown / json）

---

## 提示：你会用到哪些模式？

- [ ] **Sequential** — 合规检测流程的整体编排
- [ ] **Explore** — 理解项目结构、权限声明、系统服务清单、预置应用列表、已有安全措施
- [ ] **Specialized Agent** — 按你选择的维度拆分检测专家
- [ ] **Fan-out / Fan-in** — 并行扫描（如果你的设计允许并行）
- [ ] **Event-Driven** — 可选：Hook 在提交前自动检测合规性
- [ ] **Test-Driven** — 可选：为自动整改生成的补丁跑编译验证

---

## 参考架构

下面是一种可能的架构（按法规维度一对一映射）。你完全可以按代码区域拆、两阶段混合、或者设计其他方案。

```
comply check <path> [--standard all] [--fix] [--output markdown]
    │
    ├── 1. Explore: 理解项目结构
    │   └── 输出: 源码目录、权限声明文件、预置应用清单、系统服务列表、加密库依赖
    │
    ├── 2. 你的 agent 编排（设计由你决定）
    │   ├── 几个 agent？和法规维度一一对应还是重新组织？
    │   ├── 跨法规的关联违规怎么捕捉？
    │   └── --standard 参数如何影响 agent 的启动？
    │
    ├── 3. 收集 + 关联分析
    │   └── 去重、按法规条款排序、识别跨维度的关联违规
    │
    ├── 4. Report: 聚合 + 评级 + 渲染
    │   └── 输出: 合规报告 + 整改建议 + 入网送检风险评估
    │
    └── 5. Fix（可选）: 自动整改
        ├── 可自动修复的违规 → 生成补丁 → 验证
        └── 不可自动修复的 → 标记为需人工处理
```

---

## 验收标准

1. `comply check ./my-mobile-os --standard all` 一条命令跑完合规检测
2. 报告覆盖了所有法规领域，且能说清 agent 架构的设计理由
3. 每条违规标注法规条款、文件位置、风险等级
4. 报告包含你自己设计的评级体系和入网送检风险评估
5. 单个 agent 失败不影响其他检测结果

---

## 进阶挑战

- 支持自定义法规映射：从配置文件加载企业内部合规规则，与国家标准叠加
- 支持增量检测：只检查 git diff 中变更的文件，避免全量扫描
- 对比两次检测结果，生成合规趋势报告（整改前 vs 整改后）
- 用 Hook 实现"每次 commit 前自动检测，存在高危违规则阻止提交"
- 生成工信部送检自查表：按入网检测规范的条款结构输出自查结果，方便提交给检测机构
- 对接 Android CTS / VTS 测试结果，与 AI 检测结果交叉验证
- 支持扫描 APK/HAP 包：解析已编译的应用包，检测权限声明与实际行为是否一致
